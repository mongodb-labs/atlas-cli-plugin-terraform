resource "mongodbatlas_advanced_cluster" "dynamic_regions_config" {
  project_id   = var.project_id
  name         = "cluster"
  cluster_type = "SHARDED"
  replication_specs = [
    for i in range(var.replication_specs.num_shards) : {
      zone_name = var.zone_name
      region_configs = flatten([
        # Regions must be sorted by priority in descending order.
        for priority in range(7, 0, -1) : [
          for region in var.replication_specs.regions_config : {
            provider_name = "AWS"
            region_name   = region.region_name
            priority      = region.prio
            electable_specs = region.electable_nodes == 0 ? null : {
              node_count    = region.electable_nodes
              instance_size = "M10"
            }
            read_only_specs = region.read_only_nodes == 0 ? null : {
              node_count    = region.read_only_nodes
              instance_size = "M10"
            }
          } if priority == region.prio
        ]
      ])
    }
  ]

  # Generated by atlas-cli-plugin-terraform.
  # Please review the changes and confirm that references to this resource are updated.
}

# example of variable for demostration purposes, not used in the conversion
variable "replication_specs" {
  type = object({
    num_shards = number
    regions_config = set(object({
      region_name     = string
      electable_nodes = number
      prio            = number
      read_only_nodes = number
    }))
  })
  default = {
    num_shards = 3
    regions_config = [
      {
        region_name     = "US_EAST_1"
        electable_nodes = 3
        prio            = 7
        read_only_nodes = 0
      },
      {
        region_name     = "US_WEST_2"
        electable_nodes = 2
        prio            = 6
        read_only_nodes = 1
      }
    ]
  }
}
